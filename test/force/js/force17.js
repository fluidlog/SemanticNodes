var data = {"nodes":[
						{"id":0, "name":"0", "full_name":"0", "url": "0", "ext":"no", "type":"nav"},											
						{"id":1, "name":"1", "full_name":"1", "url": "1", "ext":"no", "type":"nav"},										
						{"id":2, "name":"Concept 2", "full_name":"2", "url": "", "ext":"no", "type":"quoi"},
						{"id":3, "name":"Concept 3", "full_name":"3", "url": "", "ext":"no", "type":"quoi"},											
						{"id":4, "name":"Concept 4", "full_name":"4", "url": "", "ext":"no", "type":"quoi"},
						{"id":5, "name":"5", "full_name":"5", "url": "5", "ext":"yes", "type":"ou"},											
						{"id":6, "name":"6", "full_name":"6", "url": "6", "ext":"yes", "type":"ou"},											
						{"id":7, "name":"7", "full_name":"7", "url": "7", "ext":"yes", "type":"comment"},											
						{"id":8, "name":"8", "full_name":"8", "url": "8", "ext":"yes", "type":"comment"},					
						{"id":9, "name":"9", "full_name":"9", "url": "9", "ext":"yes", "type":"qui"},											
						{"id":10, "name":"10", "full_name":"10", "url": "10", "ext":"yes", "type":"ou"},											
						{"id":11, "name":"11", "full_name":"11", "url": "11", "ext":"yes", "type":"qui"},											
						{"id":12, "name":"12", "full_name":"12", "url": "12", "ext":"yes", "type":"ou"},											
						{"id":13, "name":"13", "full_name":"13", "url": "13", "ext":"yes", "type":"ou"},									
						{"id":14, "name":"14", "full_name":"14", "url": "14", "ext":"yes", "type":"qui"},							
						{"id":15, "name":"15", "full_name":"15", "url": "15", "ext":"yes", "type":"ou"},							
						{"id":16, "name":"16", "full_name":"16", "url": "16", "ext":"yes", "type":"ou"},							
						{"id":17, "name":"17", "full_name":"17", "url": "17", "ext":"yes", "type":"ou"},
						{"id":18, "name":"18", "full_name":"18", "url": "18", "ext":"yes", "type":"ou"},
						{"id":19, "name":"19", "full_name":"19", "url": "19", "ext":"yes", "type":"qui"},
						{"id":20, "name":"20", "full_name":"20", "url": "20", "ext":"yes", "type":"ou"},
						{"id":21, "name":"21", "full_name":"21", "url": "21", "ext":"yes", "type":"qui"},
						{"id":22, "name":"22", "full_name":"22", "url": "22", "ext":"yes", "type":"ou"},
						{"id":23, "name":"23", "full_name":"23", "url": "", "ext":"no", "type":"quoi"},
						{"id":24, "name":"24", "full_name":"24", "url": "24", "ext":"yes", "type":"ou"},
						{"id":25, "name":"25", "full_name":"25", "url": "25", "ext":"yes", "type":"ou"},
						{"id":26, "name":"26", "full_name":"26", "url": "26", "ext":"yes", "type":"ou"},
						{"id":27, "name":"27", "full_name":"27", "url": "27", "ext":"yes", "type":"ou"},
						{"id":28, "name":"28", "full_name":"28", "url": "28", "ext":"yes", "type":"ou"},
						{"id":29, "name":"29", "full_name":"29", "url": "29", "ext":"yes", "type":"qui"},
						{"id":30, "name":"30", "full_name":"30", "url": "30", "ext":"yes", "type":"ou"},
						{"id":31, "name":"31", "full_name":"31", "url": "31", "ext":"yes", "type":"ou"},
						{"id":32, "name":"32", "full_name":"32", "url": "32", "ext":"yes", "type":"ou"},
						{"id":33, "name":"33", "full_name":"33", "url": "33", "ext":"yes", "type":"qui"},
						{"id":34, "name":"34", "full_name":"34", "url": "34", "ext":"yes", "type":"ou"},
						{"id":35, "name":"35", "full_name":"35", "url": "35", "ext":"yes", "type":"qui"},
						{"id":36, "name":"36", "full_name":"36", "url": "36", "ext":"yes", "type":"qui"},
						{"id":37, "name":"37", "full_name":"37", "url": "37", "ext":"yes", "type":"ou"},
						{"id":38, "name":"38", "full_name":"38", "url": "38", "ext":"yes", "type":"qui"},
						{"id":39, "name":"39", "full_name":"39", "url": "39", "ext":"yes", "type":"qui"},
						{"id":40, "name":"40", "full_name":"40", "url": "40", "ext":"yes", "type":"qui"},
						{"id":41, "name":"41", "full_name":"41", "url": "41", "ext":"yes", "type":"qui"},
						{"id":42, "name":"42", "full_name":"42", "url": "42", "ext":"yes", "type":"ou"},
						{"id":43, "name":"43", "full_name":"43", "url": "43", "ext":"yes", "type":"ou"},
						{"id":44, "name":"44", "full_name":"44", "url": "44", "ext":"yes", "type":"ou"},
						{"id":45, "name":"45", "full_name":"45", "url": "45", "ext":"yes", "type":"ou"},
						{"id":46, "name":"46", "full_name":"46", "url": "46", "ext":"yes", "type":"ou"},
						{"id":47, "name":"47", "full_name":"47", "url": "47", "ext":"yes", "type":"ou"},
						{"id":48, "name":"48", "full_name":"48", "url": "48", "ext":"yes", "type":"ou"},
						{"id":49, "name":"49", "full_name":"49", "url": "49", "ext":"yes", "type":"ou"},
						{"id":50, "name":"Concept 50", "full_name":"50", "url": "", "ext":"no", "type":"quoi"},											
						{"id":51, "name":"51", "full_name":"51", "url": "51", "ext":"yes", "type":"ou"},
						{"id":52, "name":"Concept 52", "full_name":"52", "url": "", "ext":"no", "type":"quoi"},											
						{"id":53, "name":"Concept 53", "full_name":"53", "url": "", "ext":"no", "type":"quoi"},											
						{"id":54, "name":"Concept 54", "full_name":"54", "url": "", "ext":"no", "type":"quoi"},											
						{"id":55, "name":"55", "full_name":"55", "url": "55", "ext":"yes", "type":"ou"},
						{"id":56, "name":"56", "full_name":"56", "url": "56", "ext":"yes", "type":"ou"},
						{"id":57, "name":"57", "full_name":"57", "url": "57", "ext":"yes", "type":"ou"},
						{"id":58, "name":"58", "full_name":"58", "url": "58", "ext":"yes", "type":"ou"},
						{"id":59, "name":"59", "full_name":"59", "url": "59", "ext":"yes", "type":"ou"},
						{"id":60, "name":"60", "full_name":"60", "url": "60", "ext":"yes", "type":"ou"},
						{"id":61, "name":"61", "full_name":"61", "url": "61", "ext":"yes", "type":"ou"},
						{"id":62, "name":"62", "full_name":"62", "url": "62", "ext":"yes", "type":"qui"},
						{"id":63, "name":"63", "full_name":"63", "url": "63", "ext":"yes", "type":"qui"},
						{"id":64, "name":"64", "full_name":"64", "url": "64", "ext":"yes", "type":"qui"},
						{"id":65, "name":"65", "full_name":"65", "url": "65", "ext":"yes", "type":"qui"},
						{"id":66, "name":"66", "full_name":"66", "url": "66", "ext":"yes", "type":"qui"},
						{"id":67, "name":"67", "full_name":"67", "url": "67", "ext":"yes", "type":"ou"},
						{"id":68, "name":"68", "full_name":"68", "url": "68", "ext":"yes", "type":"qui"},
						{"id":69, "name":"69", "full_name":"69", "url": "69", "ext":"yes", "type":"ou"},
						{"id":70, "name":"70", "full_name":"70", "url": "70", "ext":"yes", "type":"qui"},
						{"id":71, "name":"71", "full_name":"71", "url": "71", "ext":"yes", "type":"ou"},
						{"id":72, "name":"72", "full_name":"72", "url": "72", "ext":"yes", "type":"qui"},
						{"id":73, "name":"73", "full_name":"73", "url": "73", "ext":"yes", "type":"ou"},
						{"id":74, "name":"74", "full_name":"74", "url": "74", "ext":"yes", "type":"ou"},
						{"id":75, "name":"75", "full_name":"75", "url": "75", "ext":"yes", "type":"qui"},
						{"id":76, "name":"76", "full_name":"76", "url": "76", "ext":"yes", "type":"qui"},
						{"id":77, "name":"77", "full_name":"77", "url": "77", "ext":"yes", "type":"qui"},
						{"id":78, "name":"78", "full_name":"78", "url": "78", "ext":"yes", "type":"qui"},
						{"id":79, "name":"79", "full_name":"79", "url": "79", "ext":"yes", "type":"ou"},
						{"id":80, "name":"80", "full_name":"80", "url": "80", "ext":"yes", "type":"ou"},
						{"id":81, "name":"81", "full_name":"81", "url": "81", "ext":"yes", "type":"qui"},
						{"id":82, "name":"82", "full_name":"82", "url": "82", "ext":"yes", "type":"ou"},
						{"id":83, "name":"83", "full_name":"83", "url": "83", "ext":"yes", "type":"ou"},
						{"id":84, "name":"84", "full_name":"84", "url": "84", "ext":"yes", "type":"ou"},
						{"id":85, "name":"85", "full_name":"85", "url": "85", "ext":"yes", "type":"ou"},
						{"id":86, "name":"86", "full_name":"86", "url": "86", "ext":"yes", "type":"ou"},
						{"id":87, "name":"87", "full_name":"87", "url": "87", "ext":"yes", "type":"ou"},
						{"id":88, "name":"88", "full_name":"88", "url": "88", "ext":"yes", "type":"ou"},
						{"id":89, "name":"89", "full_name":"89", "url": "89", "ext":"yes", "type":"ou"},
						{"id":90, "name":"90", "full_name":"90", "url": "90", "ext":"yes", "type":"ou"},
						{"id":91, "name":"91", "full_name":"91", "url": "91", "ext":"yes", "type":"ou"},
						{"id":92, "name":"92", "full_name":"92", "url": "92", "ext":"yes", "type":"ou"},
						{"id":93, "name":"93", "full_name":"93", "url": "93", "ext":"yes", "type":"ou"},
						{"id":94, "name":"94", "full_name":"94", "url": "94", "ext":"yes", "type":"ou"},
						{"id":95, "name":"95", "full_name":"95", "url": "95", "ext":"yes", "type":"ou"},
						{"id":96, "name":"96", "full_name":"96", "url": "96", "ext":"yes", "type":"ou"},
						{"id":97, "name":"97", "full_name":"97", "url": "97", "ext":"yes", "type":"ou"},
						{"id":98, "name":"98", "full_name":"98", "url": "98", "ext":"yes", "type":"ou"},
						{"id":99, "name":"99", "full_name":"99", "url": "99", "ext":"yes", "type":"ou"},
						{"id":100, "name":"100", "full_name":"100", "url": "100", "ext":"yes", "type":"ou"},
						{"id":101, "name":"101", "full_name":"101", "url": "101", "ext":"yes", "type":"ou"},
						{"id":102, "name":"102", "full_name":"102", "url": "102", "ext":"yes", "type":"ou"},
						{"id":103, "name":"103", "full_name":"103", "url": "103", "ext":"yes", "type":"ou"},
						{"id":104, "name":"104", "full_name":"104", "url": "104", "ext":"yes", "type":"ou"},
						{"id":105, "name":"105", "full_name":"105", "url": "105", "ext":"yes", "type":"ou"},
						{"id":106, "name":"106", "full_name":"106", "url": "106", "ext":"yes", "type":"ou"},
					], 
			"links":[
						{"source":0,"target":1},
						{"source":2,"target":3},
						{"source":2,"target":4},
						{"source":4,"target":5},
						{"source":4,"target":6},
						{"source":5,"target":7},
						{"source":6,"target":8},
						{"source":3,"target":10},
						{"source":10,"target":9},
						{"source":3,"target":13},
						{"source":13,"target":14},
						{"source":3,"target":12},
						{"source":3,"target":15},
						{"source":3,"target":16},
						{"source":12,"target":11},
						{"source":2,"target":17},
						{"source":2,"target":18},
						{"source":17,"target":19},
						{"source":18,"target":19},
						{"source":2,"target":20},
						{"source":2,"target":21},
						{"source":2,"target":22},
						{"source":2,"target":23},
						{"source":23,"target":24},
						{"source":23,"target":25},
						{"source":2,"target":26},
						{"source":2,"target":27},
						{"source":2,"target":28},
						{"source":3,"target":29},
						{"source":3,"target":21},
						{"source":2,"target":30},
						{"source":2,"target":31},
						{"source":2,"target":32},
						{"source":32,"target":33},
						{"source":2,"target":34},
						{"source":34,"target":35},
						{"source":34,"target":36},
						{"source":34,"target":3},
						{"source":34,"target":37},
						{"source":2,"target":37},
						{"source":3,"target":37},
						{"source":37,"target":38},
						{"source":37,"target":32},
						{"source":37,"target":12},
						{"source":34,"target":12},
						{"source":37,"target":39},
						{"source":37,"target":40},
						{"source":36,"target":3},
						{"source":2,"target":12},
						{"source":3,"target":38},
						{"source":3,"target":39},
						{"source":34,"target":41},
						{"source":41,"target":3},
						{"source":2,"target":42},
						{"source":2,"target":43},
						{"source":2,"target":44},
						{"source":2,"target":45},
						{"source":3,"target":46},
						{"source":23,"target":47},
						{"source":3,"target":48},
						{"source":3,"target":49},
						{"source":3,"target":50},
						{"source":3,"target":52},
						{"source":3,"target":53},
						{"source":50,"target":51},
						{"source":3,"target":54},
						{"source":54,"target":55},
						{"source":54,"target":56},
						{"source":54,"target":57},
						{"source":52,"target":53},
						{"source":53,"target":58},
						{"source":53,"target":59},
						{"source":53,"target":60},
						{"source":52,"target":54},
						{"source":53,"target":61},
						{"source":3,"target":59},
						{"source":52,"target":59},
						{"source":49,"target":57},
						{"source":48,"target":51},
						{"source":49,"target":62},
						{"source":3,"target":63},
						{"source":3,"target":62},
						{"source":3,"target":64},
						{"source":16,"target":64},
						{"source":3,"target":65},
						{"source":15,"target":65},
						{"source":2,"target":66},
						{"source":3,"target":67},
						{"source":2,"target":67},
						{"source":2,"target":68},
						{"source":2,"target":69},
						{"source":3,"target":70},
						{"source":3,"target":71},
						{"source":2,"target":72},
						{"source":3,"target":72},
						{"source":3,"target":73},
						{"source":3,"target":74},
						{"source":74,"target":75},
						{"source":73,"target":76},
						{"source":3,"target":76},
						{"source":2,"target":77},
						{"source":5,"target":77},
						{"source":5,"target":78},
						{"source":2,"target":79},
						{"source":29,"target":71},
						{"source":2,"target":80},
						{"source":53,"target":81},
						{"source":2,"target":82},
						{"source":3,"target":83},
						{"source":3,"target":84},
						{"source":2,"target":85},
						{"source":2,"target":86},
						{"source":2,"target":87},
						{"source":2,"target":88},
						{"source":2,"target":89},
						{"source":2,"target":90},
						{"source":2,"target":91},
						{"source":3,"target":92},
						{"source":2,"target":93},
						{"source":2,"target":94},
						{"source":2,"target":95},
						{"source":2,"target":96},
						{"source":3,"target":97},
						{"source":2,"target":98},
						{"source":3,"target":98},
						{"source":2,"target":99},
						{"source":2,"target":100},
						{"source":3,"target":101},
						{"source":3,"target":102},
						{"source":3,"target":103},
						{"source":3,"target":104},
						{"source":2,"target":105},
						{"source":2,"target":106},
					]
			   }    


var n = 100,
	node,
	link,
    nodes,
    links,
	width = window.innerWidth - 30, 
	height = window.innerHeight - 30;

var colors = d3.scale.category10();
var FontFamily = "Helvetica Neue, Helvetica, Arial, sans-serif;"

var node_drag = d3.behavior.drag()
	.on("dragstart", dragstart)
	.on("drag", dragmove)
	.on("dragend", dragend);

var svg = d3.select("body")
	.append("svg:svg")
	.attr("width", width)
	.attr("height", height)
	.attr("pointer-events", "all")
	.append('svg:g')
	.call(d3.behavior.zoom().on("zoom", rescale))
	.on("dblclick.zoom", null)
	.append('svg:g')

//rescale g
function rescale() {
  svg.attr("transform",
      "translate(" + d3.event.translate + ")"
      + " scale(" + d3.event.scale + ")");
}

var socle = svg.append('svg:rect')
				.attr('width', width)
				.attr('height', height)
				.attr('fill', 'transparent')
				.style("cursor", "move")

var force = d3.layout.force()
	.nodes(data.nodes)
	.links(data.links)
	.size([width, height])
    .linkDistance(120)
	.charge([-3000])

force.start();
for (var i = n * n; i > 0; --i) force.tick();
force.stop();

var link = svg.selectAll("line.link")
	.data(data.links)
	.enter().append("svg:line")
	.attr("x1", function(d) { return d.source.x; })
	.attr("y1", function(d) { return d.source.y; })
	.attr("x2", function(d) { return d.target.x; })
	.attr("y2", function(d) { return d.target.y; })
    .attr("class", "link")
    .style("stroke", "#DDD")
    .style("stroke-width", 5)
	
var node = svg.selectAll("g.node")
				.data(data.nodes)
				.enter().append("svg:g")
				.attr("class", "node")
				.call(node_drag);

/* ---------------------------------------------------------------- *
 * Habillage des noeuds et du text sur le noeud
 * ---------------------------------------------------------------- */

/* Cercle qui apparait sur le hover */
node.append("circle")
	.attr("cx", 0)
	.attr("cy", -5)
	.attr("r", 0)
    .attr("class", "CircleOptions")
	.style("fill", "white")
	.style("stroke", "#aaa")
	.style("fill-opacity", "0")
	.style("stroke-width", "5")

/* Option de déplacement */
node.append("circle")
	.attr("cx", -30)
	.attr("cy", -30)
	.attr("r", 0)
    .attr("class", "CircleF")
	.style("stroke", "aaa")
	.attr("fill", "white")
	.style("fill-opacity", "1")
	.style("stroke-width", "2")

node.append("svg:image")
    		.attr("class", "ImageF")
			.attr('x', -40)
			.attr('y', -40)
			.attr('width', 20)
			.attr('height', 20)
			.style("visibility", "hidden")
			.attr("xlink:href","http://fluidlog.com/img/move_64.png")
	.style("cursor", "move")

/* Option de link */
node.append("circle")
	.attr("cx", 30)
	.attr("cy", -30)
	.attr("r", 0)
    .attr("class", "CircleL")
	.style("stroke", "aaa")
	.attr("fill", "white")
	.style("fill-opacity", "1")
	.style("stroke-width", "2")

node.append("svg:image")
    		.attr("class", "ImageL")
			.attr('x', 20)
			.attr('y', -40)
			.attr('width', 20)
			.attr('height', 20)
			.style("visibility", "hidden")
			.style("cursor", "pointer")
			.attr("xlink:href","http://fluidlog.com/img/arrow_full_upperright_64.png")
			.on("click", openLink())

// Création d'un rectangle à bord arrondis à la place d'un cercle
var rect = node.append("rect")
	.attr("x", function(d) { return -(11*d.name.length / 2) })
	.attr("y", "-17")
	.attr("rx", 10) //Gère les bords arrondis
	.attr("ry", 10) //Gère les bords arrondis
	  .style("stroke", "#DDD")
	  .style("stroke-width", "4")
	.attr("width", function(d) { return 11*d.name.length })
	.attr("fill", color)
	.style("opacity", 1)
	.attr("height", "25")

node.append("title")
	.text(function(d) { return d.full_name; })

node.append("text")
	.attr("text-anchor", "middle")
	.style("font-size", "14")
	.style("fill", "white")
	.style("font-family", "Courier New")
	.style("pointer-events", function(d)
		{
			if (d.type == "quoi") 
				return "none";
		}
	)
	.text(function(d) { return d.name })

/* ---------------------------------------------------------------- *
 * Gestion du hover
 * ---------------------------------------------------------------- */

node.on("mouseover", function (d) 
	{
		d3.select(this).select('rect')
						.style("opacity", fade(.2,"#aaa"))
		
		d3.select(this).select('.CircleOptions')
						.transition()
						.duration(300)
						.attr("r", 40)

		d3.select(this).select('.CircleF')
						.transition()
						.duration(300)
						.attr("r", 10)

		d3.select(this).select('.ImageF')
						.transition()
						.duration(300)
						.style("visibility", "visible")

		if (d.url != "")
		{
			d3.select(this).select('.ImageL')
							.transition()
							.duration(300)
							.style("visibility", "visible")

			d3.select(this).select('.CircleL')
							.transition()
							.duration(300)
							.attr("r", 10)
		}
	}
);
	 
node.on("mouseout", function (d) 
	{
		d3.select(this).select('rect')
						.style("opacity", fade(1,"#DDD"))

		d3.select(this).select('.CircleOptions')
						.transition()
						.duration(300)
						.attr("r", 0)

		d3.select(this).select('.CircleF')
						.transition()
						.duration(300)
						.attr("r", 0)

		d3.select(this).select('.ImageF')
						.transition()
						.duration(300)
						.style("visibility", "hidden")

		if (d.url != "")
		{
			d3.select(this).select('.ImageL')
							.transition()
							.duration(300)
							.style("visibility", "hidden")

			d3.select(this).select('.CircleL')
							.transition()
							.duration(300)
							.attr("r", 0)
		}
	}
);

force.on("tick", tick);

resize();
d3.select(window).on("resize", resize);

function resize() {
    width = window.innerWidth; 
    height = window.innerHeight;
    svg.attr("width", width).attr("height", height);
    socle.attr('width', width).attr('height', height)

    force.size([width, height]).resume();
}

var linkedByIndex = {};
data.links.forEach(function(d) {
    linkedByIndex[d.source.index + "," + d.target.index] = 1;
});

function isConnected(a, b) {
    return linkedByIndex[a.index + "," + b.index] || linkedByIndex[b.index + "," + a.index] || a.index == b.index;
}

function fade(opacity,color) 
{
    return function(d) 
    {
		rect.style("opacity", function(o) 
				{
					return isConnected(d, o) ? 1 : opacity;
				})
		
		.style("stroke", function(o) 
				{
					return isConnected(d, o) ? color : "#DDD";
				});

		link.style("stroke-opacity", function(o) {
            return o.source === d || o.target === d ? 1 : opacity;
        })
        
        .style("stroke", function(o) {
            return o.source === d || o.target === d ? color : color ;
        });
    }
}

function dragstart(d, i) 
{
	d3.event.sourceEvent.stopPropagation();
	force.stop();
}

function dragmove(d, i) {
	d.px += d3.event.dx;
	d.py += d3.event.dy;
	d.x += d3.event.dx;
	d.y += d3.event.dy; 
	tick(); // this is the key to make it work together with updating both px,py,x,y on d !
}

function dragend(d, i) {
	d3.select(this).classed("fixed", d.fixed = true)
					.select(".nodecircle").style("stroke", "#999");
	tick();
	force.resume();
}

function openLink() 
{
	return function(d) 
	{
		if(d.type != "quoi") 
			if(d.ext == "yes") 
				window.open("//"+d.url)
			else
				window.open("//"+d.url,"_self")
	}
}

function color(d) 
{
	switch (d.type)
	{
		case "qui" : 
			return "orange";
		break
		case "quoi" : 
			return "#A00";
		break
		case "ou" : 
			return "#00A";
		break
		case "comment" : 
			return "#0A0";
		break
	}
}

function tick() {
	  link.attr("x1", function(d) { return d.source.x; })
	      .attr("y1", function(d) { return d.source.y; })
	      .attr("x2", function(d) { return d.target.x; })
	      .attr("y2", function(d) { return d.target.y; });

	  node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
}
